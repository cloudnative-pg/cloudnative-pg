apiVersion: v1
kind: Namespace
metadata:
  labels:
    control-plane: controller-manager
  name: postgresql-operator-system
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.3.0
  creationTimestamp: null
  name: backups.postgresql.k8s.2ndq.io
spec:
  group: postgresql.k8s.2ndq.io
  names:
    kind: Backup
    listKind: BackupList
    plural: backups
    singular: backup
  scope: Namespaced
  subresources:
    status: {}
  validation:
    openAPIV3Schema:
      description: Backup is the Schema for the backups API
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
          type: string
        metadata:
          type: object
        spec:
          description: BackupSpec defines the desired state of Backup
          properties:
            cluster:
              description: The cluster to backup
              properties:
                name:
                  description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names TODO: Add other useful fields. apiVersion, kind, uid?'
                  type: string
              type: object
          type: object
        status:
          description: BackupStatus defines the observed state of Backup
          properties:
            commandError:
              description: The backup command output
              type: string
            commandOutput:
              description: The backup command output
              type: string
            error:
              description: The detected error
              type: string
            phase:
              description: The last backup status
              type: string
            startedAt:
              description: When the backup was started
              format: date-time
              type: string
            stoppedAt:
              description: When the backup was terminated
              format: date-time
              type: string
          type: object
      type: object
  version: v1alpha1
  versions:
  - name: v1alpha1
    served: true
    storage: true
status:
  acceptedNames:
    kind: ""
    plural: ""
  conditions: []
  storedVersions: []
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.3.0
  creationTimestamp: null
  name: clusters.postgresql.k8s.2ndq.io
spec:
  group: postgresql.k8s.2ndq.io
  names:
    kind: Cluster
    listKind: ClusterList
    plural: clusters
    singular: cluster
  scope: Namespaced
  subresources:
    scale:
      specReplicasPath: .spec.instances
      statusReplicasPath: .status.instances
    status: {}
  validation:
    openAPIV3Schema:
      description: Cluster is the Schema for the postgresqls API
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
          type: string
        metadata:
          type: object
        spec:
          description: ClusterSpec defines the desired state of Cluster
          properties:
            affinity:
              description: Affinity/Anti-affinity rules for Pods
              properties:
                enablePodAntiAffinity:
                  description: Should we enable anti affinity or not?
                  type: boolean
                topologyKey:
                  description: TopologyKey to use for anti-affinity configuration. See k8s documentation for more info on that
                  type: string
              required:
              - enablePodAntiAffinity
              type: object
            applicationConfiguration:
              description: Configuration from the application point of view
              properties:
                database:
                  description: Name of the database used by the application
                  minLength: 1
                  type: string
                owner:
                  description: Name of the owner of the database in the instance to be used by applications.
                  minLength: 1
                  type: string
              required:
              - database
              - owner
              type: object
            backup:
              description: The configuration to be used for backups
              properties:
                data:
                  description: The configuration to be used to backup the data files
                  properties:
                    compression:
                      description: Whenever to compress files or not
                      type: string
                    encryption:
                      description: Whenever to force the encryption of files (if the bucket is not already configured for that)
                      type: string
                    immediateCheckpoint:
                      description: Whenever to force the initial checkpoint to be done as quickly as possible
                      type: boolean
                    jobs:
                      description: The number of jobs to be used to upload the backup, defaults to 2
                      format: int32
                      type: integer
                  type: object
                destinationPath:
                  description: The path where to store the backup (i.e. s3://bucket/path/to/folder) this path, with different destination folders, will be used for WALs and for data
                  minLength: 1
                  type: string
                endpointURL:
                  description: Endpoint to be used to upload data to the cloud, overriding the automatic endpoint discovery
                  type: string
                s3Credentials:
                  description: The credentials to use to upload data to S3
                  properties:
                    accessKeyId:
                      description: The reference to the access key id
                      properties:
                        key:
                          description: The key of the secret to select from.  Must be a valid secret key.
                          type: string
                        name:
                          description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names TODO: Add other useful fields. apiVersion, kind, uid?'
                          type: string
                        optional:
                          description: Specify whether the Secret or its key must be defined
                          type: boolean
                      required:
                      - key
                      type: object
                    secretAccessKey:
                      description: The reference to the secret access key
                      properties:
                        key:
                          description: The key of the secret to select from.  Must be a valid secret key.
                          type: string
                        name:
                          description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names TODO: Add other useful fields. apiVersion, kind, uid?'
                          type: string
                        optional:
                          description: Specify whether the Secret or its key must be defined
                          type: boolean
                      required:
                      - key
                      type: object
                  required:
                  - accessKeyId
                  - secretAccessKey
                  type: object
                serverName:
                  description: The server name on S3, the cluster name is used if this parameter is omitted
                  type: string
                wal:
                  description: The configuration for the backup of the WAL stream
                  properties:
                    compression:
                      description: Whenever to compress files or not
                      type: string
                    encryption:
                      description: Whenever to force the encryption of files (if the bucket is not already configured for that)
                      type: string
                  type: object
              required:
              - destinationPath
              - s3Credentials
              type: object
            description:
              description: Description of this PostgreSQL cluster
              type: string
            imageName:
              description: Name of the container image
              minLength: 0
              type: string
            imagePullSecret:
              description: Secret for pulling the image. If empty no secret will be used
              type: string
            instances:
              description: Number of instances required in the cluster
              format: int32
              minimum: 1
              type: integer
            postgresql:
              description: Configuration of the PostgreSQL server
              properties:
                parameters:
                  description: PostgreSQL configuration options (postgresql.conf)
                  items:
                    type: string
                  type: array
                pg_hba:
                  description: PostgreSQL Host Based Authentication rules (lines to be appended to the pg_hba.conf file)
                  items:
                    type: string
                  type: array
              required:
              - parameters
              - pg_hba
              type: object
            primaryUpdateStrategy:
              description: 'Strategy to follow to upgrade the primary server during a rolling update procedure, after all replicas have been successfully updated: it can be automated (`unsupervised` - default) or manual (`supervised`)'
              type: string
            resources:
              description: Resources requirements of every generated Pod
              properties:
                limits:
                  additionalProperties:
                    anyOf:
                    - type: integer
                    - type: string
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  description: 'Limits describes the maximum amount of compute resources allowed. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/'
                  type: object
                requests:
                  additionalProperties:
                    anyOf:
                    - type: integer
                    - type: string
                    pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                    x-kubernetes-int-or-string: true
                  description: 'Requests describes the minimum amount of compute resources required. If Requests is omitted for a container, it defaults to Limits if that is explicitly specified, otherwise to an implementation-defined value. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/'
                  type: object
              type: object
            startDelay:
              description: The time in seconds that is allowed for a PostgreSQL instance to successfully start up (default 30)
              format: int32
              type: integer
            stopDelay:
              description: The time in seconds that is allowed for a PostgreSQL instance node to gracefully shutdown (default 30)
              format: int32
              type: integer
            storage:
              description: Configuration of the storage of the instances
              properties:
                pvcTemplate:
                  description: Template to be used to generate the Persistent Volume Claim
                  properties:
                    accessModes:
                      description: 'AccessModes contains the desired access modes the volume should have. More info: https://kubernetes.io/docs/concepts/storage/persistent-volumes#access-modes-1'
                      items:
                        type: string
                      type: array
                    dataSource:
                      description: This field requires the VolumeSnapshotDataSource alpha feature gate to be enabled and currently VolumeSnapshot is the only supported data source. If the provisioner can support VolumeSnapshot data source, it will create a new volume and data will be restored to the volume at the same time. If the provisioner does not support VolumeSnapshot data source, volume will not be created and the failure will be reported as an event. In the future, we plan to support more data source types and the behavior of the provisioner may change.
                      properties:
                        apiGroup:
                          description: APIGroup is the group for the resource being referenced. If APIGroup is not specified, the specified Kind must be in the core API group. For any other third-party types, APIGroup is required.
                          type: string
                        kind:
                          description: Kind is the type of resource being referenced
                          type: string
                        name:
                          description: Name is the name of resource being referenced
                          type: string
                      required:
                      - kind
                      - name
                      type: object
                    resources:
                      description: 'Resources represents the minimum resources the volume should have. More info: https://kubernetes.io/docs/concepts/storage/persistent-volumes#resources'
                      properties:
                        limits:
                          additionalProperties:
                            anyOf:
                            - type: integer
                            - type: string
                            pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                            x-kubernetes-int-or-string: true
                          description: 'Limits describes the maximum amount of compute resources allowed. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/'
                          type: object
                        requests:
                          additionalProperties:
                            anyOf:
                            - type: integer
                            - type: string
                            pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                            x-kubernetes-int-or-string: true
                          description: 'Requests describes the minimum amount of compute resources required. If Requests is omitted for a container, it defaults to Limits if that is explicitly specified, otherwise to an implementation-defined value. More info: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/'
                          type: object
                      type: object
                    selector:
                      description: A label query over volumes to consider for binding.
                      properties:
                        matchExpressions:
                          description: matchExpressions is a list of label selector requirements. The requirements are ANDed.
                          items:
                            description: A label selector requirement is a selector that contains values, a key, and an operator that relates the key and values.
                            properties:
                              key:
                                description: key is the label key that the selector applies to.
                                type: string
                              operator:
                                description: operator represents a key's relationship to a set of values. Valid operators are In, NotIn, Exists and DoesNotExist.
                                type: string
                              values:
                                description: values is an array of string values. If the operator is In or NotIn, the values array must be non-empty. If the operator is Exists or DoesNotExist, the values array must be empty. This array is replaced during a strategic merge patch.
                                items:
                                  type: string
                                type: array
                            required:
                            - key
                            - operator
                            type: object
                          type: array
                        matchLabels:
                          additionalProperties:
                            type: string
                          description: matchLabels is a map of {key,value} pairs. A single {key,value} in the matchLabels map is equivalent to an element of matchExpressions, whose key field is "key", the operator is "In", and the values array contains only "value". The requirements are ANDed.
                          type: object
                      type: object
                    storageClassName:
                      description: 'Name of the StorageClass required by the claim. More info: https://kubernetes.io/docs/concepts/storage/persistent-volumes#class-1'
                      type: string
                    volumeMode:
                      description: volumeMode defines what type of volume is required by the claim. Value of Filesystem is implied when not included in claim spec. This is a beta feature.
                      type: string
                    volumeName:
                      description: VolumeName is the binding reference to the PersistentVolume backing this claim.
                      type: string
                  type: object
                size:
                  anyOf:
                  - type: integer
                  - type: string
                  description: Size of the storage. Required if not already specified in the PVC template.
                  pattern: ^(\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))(([KMGTPE]i)|[numkMGTPE]|([eE](\+|-)?(([0-9]+(\.[0-9]*)?)|(\.[0-9]+))))?$
                  x-kubernetes-int-or-string: true
                storageClass:
                  description: StorageClass to use for database data (PGDATA). Applied after evaluating the PVC template, if available.
                  type: string
              type: object
          required:
          - applicationConfiguration
          - instances
          - postgresql
          type: object
        status:
          description: ClusterStatus defines the observed state of Cluster
          properties:
            currentPrimary:
              description: Current primary instance
              type: string
            danglingPVC:
              description: List of all the PVCs created by this bdrGroup and still available which are not attached to a Pod
              items:
                type: string
              type: array
            instances:
              description: Total number of instances in the cluster
              format: int32
              type: integer
            latestGeneratedNode:
              description: ID of the latest generated node (used to avoid node name clashing)
              format: int32
              type: integer
            readyInstances:
              description: Total number of ready instances in the cluster
              format: int32
              type: integer
            targetPrimary:
              description: Target primary instance, this is different from the previous one during a switchover or a failover
              type: string
          type: object
      type: object
  version: v1alpha1
  versions:
  - name: v1alpha1
    served: true
    storage: true
status:
  acceptedNames:
    kind: ""
    plural: ""
  conditions: []
  storedVersions: []
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.3.0
  creationTimestamp: null
  name: scheduledbackups.postgresql.k8s.2ndq.io
spec:
  group: postgresql.k8s.2ndq.io
  names:
    kind: ScheduledBackup
    listKind: ScheduledBackupList
    plural: scheduledbackups
    singular: scheduledbackup
  scope: Namespaced
  subresources:
    status: {}
  validation:
    openAPIV3Schema:
      description: ScheduledBackup is the Schema for the scheduledbackups API
      properties:
        apiVersion:
          description: 'APIVersion defines the versioned schema of this representation of an object. Servers should convert recognized schemas to the latest internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
          type: string
        kind:
          description: 'Kind is a string value representing the REST resource this object represents. Servers may infer this from the endpoint the client submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
          type: string
        metadata:
          type: object
        spec:
          description: ScheduledBackupSpec defines the desired state of ScheduledBackup
          properties:
            cluster:
              description: The cluster to backup
              properties:
                name:
                  description: 'Name of the referent. More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names TODO: Add other useful fields. apiVersion, kind, uid?'
                  type: string
              type: object
            schedule:
              description: The schedule in Cron format, see https://en.wikipedia.org/wiki/Cron.
              type: string
            suspend:
              description: If this backup is suspended of not
              type: boolean
          required:
          - schedule
          type: object
        status:
          description: ScheduledBackupStatus defines the observed state of ScheduledBackup
          properties:
            lastCheckTime:
              description: The latest time the schedule
              format: date-time
              type: string
            lastScheduleTime:
              description: Information when was the last time that backup was successfully scheduled.
              format: date-time
              type: string
          type: object
      type: object
  version: v1alpha1
  versions:
  - name: v1alpha1
    served: true
    storage: true
status:
  acceptedNames:
    kind: ""
    plural: ""
  conditions: []
  storedVersions: []
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: postgresql-operator-manager
  namespace: postgresql-operator-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  creationTimestamp: null
  name: postgresql-operator-manager
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - configmaps/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims
  verbs:
  - create
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - watch
- apiGroups:
  - ""
  resources:
  - pods/exec
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - watch
- apiGroups:
  - ""
  resources:
  - pods/status
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - create
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - serviceaccounts
  verbs:
  - create
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - policy
  resources:
  - poddisruptionbudgets
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - postgresql.k8s.2ndq.io
  resources:
  - backups
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - postgresql.k8s.2ndq.io
  resources:
  - backups/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - postgresql.k8s.2ndq.io
  resources:
  - clusters
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - postgresql.k8s.2ndq.io
  resources:
  - clusters/finalizers
  verbs:
  - update
- apiGroups:
  - postgresql.k8s.2ndq.io
  resources:
  - clusters/status
  verbs:
  - get
  - patch
  - update
  - watch
- apiGroups:
  - postgresql.k8s.2ndq.io
  resources:
  - scheduledbackups
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - postgresql.k8s.2ndq.io
  resources:
  - scheduledbackups/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - rolebindings
  verbs:
  - create
  - patch
  - update
- apiGroups:
  - rbac.authorization.k8s.io
  resources:
  - roles
  verbs:
  - create
  - patch
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: postgresql-operator-proxy-role
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: postgresql-operator-metrics-reader
rules:
- nonResourceURLs:
  - /metrics
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: postgresql-operator-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: postgresql-operator-manager
subjects:
- kind: ServiceAccount
  name: postgresql-operator-manager
  namespace: postgresql-operator-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: postgresql-operator-proxy-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: postgresql-operator-proxy-role
subjects:
- kind: ServiceAccount
  name: postgresql-operator-manager
  namespace: postgresql-operator-system
---
apiVersion: v1
data:
  POSTGRES_IMAGE_NAME: quay.io/2ndquadrant/postgres:latest
kind: ConfigMap
metadata:
  name: postgresql-operator-controller-manager-env-8hcb6t9bfh
  namespace: postgresql-operator-system
---
apiVersion: v1
kind: Service
metadata:
  labels:
    control-plane: controller-manager
  name: postgresql-operator-controller-manager-metrics-service
  namespace: postgresql-operator-system
spec:
  ports:
  - name: https
    port: 8443
    targetPort: https
  selector:
    control-plane: controller-manager
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    control-plane: controller-manager
  name: postgresql-operator-controller-manager
  namespace: postgresql-operator-system
spec:
  replicas: 1
  selector:
    matchLabels:
      control-plane: controller-manager
  template:
    metadata:
      labels:
        control-plane: controller-manager
    spec:
      containers:
      - args:
        - --metrics-addr=127.0.0.1:8080
        - --enable-leader-election
        command:
        - /manager
        env:
        - name: OPERATOR_IMAGE_NAME
          value: 2ndq.io/release/k8s/cloud-native-postgresql-operator:v0.2.0
        envFrom:
        - configMapRef:
            name: postgresql-operator-controller-manager-env-8hcb6t9bfh
        image: 2ndq.io/release/k8s/cloud-native-postgresql-operator:v0.2.0
        name: manager
        resources:
          limits:
            cpu: 100m
            memory: 30Mi
          requests:
            cpu: 100m
            memory: 20Mi
      - args:
        - --secure-listen-address=0.0.0.0:8443
        - --upstream=http://127.0.0.1:8080/
        - --logtostderr=true
        - --v=10
        image: gcr.io/kubebuilder/kube-rbac-proxy:v0.4.1
        name: kube-rbac-proxy
        ports:
        - containerPort: 8443
          name: https
      imagePullSecrets:
      - name: postgresql-operator-pull-secret
      securityContext:
        runAsUser: 1001
      serviceAccountName: postgresql-operator-manager
      terminationGracePeriodSeconds: 10
---
apiVersion: v1
data:
  .dockerconfigjson: %%SECRET%%
kind: Secret
metadata:
  name: postgresql-operator-pull-secret
  namespace: postgresql-operator-system
type: kubernetes.io/dockerconfigjson
