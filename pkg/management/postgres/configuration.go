/*
This file is part of Cloud Native PostgreSQL.

Copyright (C) 2019-2020 2ndQuadrant Italia SRL. Exclusively licensed to 2ndQuadrant Limited.
*/

package postgres

import (
	"fmt"
	"path"

	"gitlab.2ndquadrant.com/k8s/cloud-native-postgresql/pkg/fileutils"
	"gitlab.2ndquadrant.com/k8s/cloud-native-postgresql/pkg/management/log"
)

// InstallCustomConfigurationFile install in the PgData the file with
// the PostgreSQL settings which have been generated by the operator
func InstallCustomConfigurationFile(pgdata, filename string) error {
	if filename == "" || pgdata == "" {
		return nil
	}

	contents, err := fileutils.ReadFile(filename)
	if err != nil {
		return fmt.Errorf("while reading custom configuration file: %w", err)
	}

	return InstallPgDataFileContent(pgdata, contents, PostgresqlCustomConfigurationFile)
}

// InstallPgHBAFile install in the PgData the file containing
// the host-based access rules which is being managed by the operator
func InstallPgHBAFile(pgdata, filename string) error {
	if filename == "" || pgdata == "" {
		return nil
	}

	contents, err := fileutils.ReadFile(filename)
	if err != nil {
		return fmt.Errorf("while reading hba file: %w", err)
	}

	return InstallPgDataFileContent(
		pgdata,
		contents,
		PostgresqlHBARulesFile)
}

// InstallPgDataFileContent install a file in PgData
func InstallPgDataFileContent(pgdata, contents, destinationFile string) error {
	log.Log.Info(
		"Installing configuration file",
		"pgdata", pgdata,
		"filename", destinationFile)

	targetFile := path.Join(pgdata, destinationFile)
	return fileutils.WriteStringToFile(targetFile, contents)
}
