---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.13.0
  name: poolers.postgresql.cnpg.io
spec:
  group: postgresql.cnpg.io
  names:
    kind: Pooler
    listKind: PoolerList
    plural: poolers
    singular: pooler
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    - jsonPath: .spec.cluster.name
      name: Cluster
      type: string
    - jsonPath: .spec.type
      name: Type
      type: string
    name: v1
    schema:
      openAPIV3Schema:
        description: Pooler is the Schema for the poolers API
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object. Servers should convert recognized schemas to the latest
              internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents. Servers may infer this from the endpoint the client
              submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds'
            type: string
          metadata:
            type: object
          spec:
            description: 'Specification of the desired behavior of the Pooler. More
              info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
            properties:
              cluster:
                description: This is the cluster reference on which the Pooler will
                  work. Pooler name should never match with any cluster name within
                  the same namespace.
                properties:
                  name:
                    description: Name of the referent.
                    type: string
                required:
                - name
                type: object
              deploymentStrategy:
                description: The deployment strategy to use for pgbouncer to replace
                  existing pods with new ones
                properties:
                  rollingUpdate:
                    description: 'Rolling update config params. Present only if DeploymentStrategyType
                      = RollingUpdate. --- TODO: Update this to follow our convention
                      for oneOf, whatever we decide it to be.'
                    properties:
                      maxSurge:
                        anyOf:
                        - type: integer
                        - type: string
                        description: 'The maximum number of pods that can be scheduled
                          above the desired number of pods. Value can be an absolute
                          number (ex: 5) or a percentage of desired pods (ex: 10%).
                          This can not be 0 if MaxUnavailable is 0. Absolute number
                          is calculated from percentage by rounding up. Defaults to
                          25%. Example: when this is set to 30%, the new ReplicaSet
                          can be scaled up immediately when the rolling update starts,
                          such that the total number of old and new pods do not exceed
                          130% of desired pods. Once old pods have been killed, new
                          ReplicaSet can be scaled up further, ensuring that total
                          number of pods running at any time during the update is
                          at most 130% of desired pods.'
                        x-kubernetes-int-or-string: true
                      maxUnavailable:
                        anyOf:
                        - type: integer
                        - type: string
                        description: 'The maximum number of pods that can be unavailable
                          during the update. Value can be an absolute number (ex:
                          5) or a percentage of desired pods (ex: 10%). Absolute number
                          is calculated from percentage by rounding down. This can
                          not be 0 if MaxSurge is 0. Defaults to 25%. Example: when
                          this is set to 30%, the old ReplicaSet can be scaled down
                          to 70% of desired pods immediately when the rolling update
                          starts. Once new pods are ready, old ReplicaSet can be scaled
                          down further, followed by scaling up the new ReplicaSet,
                          ensuring that the total number of pods available at all
                          times during the update is at least 70% of desired pods.'
                        x-kubernetes-int-or-string: true
                    type: object
                  type:
                    description: Type of deployment. Can be "Recreate" or "RollingUpdate".
                      Default is RollingUpdate.
                    type: string
                type: object
              instances:
                default: 1
                description: 'The number of replicas we want. Default: 1.'
                format: int32
                type: integer
              monitoring:
                description: The configuration of the monitoring infrastructure of
                  this pooler.
                properties:
                  enablePodMonitor:
                    default: false
                    description: Enable or disable the `PodMonitor`
                    type: boolean
                  podMonitorMetricRelabelings:
                    description: The list of metric relabelings for the `PodMonitor`.
                      Applied to samples before ingestion.
                    items:
                      description: "RelabelConfig allows dynamic rewriting of the
                        label set for targets, alerts, scraped samples and remote
                        write samples. \n More info: https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config"
                      properties:
                        action:
                          default: replace
                          description: "Action to perform based on the regex matching.
                            \n `Uppercase` and `Lowercase` actions require Prometheus
                            >= v2.36.0. `DropEqual` and `KeepEqual` actions require
                            Prometheus >= v2.41.0. \n Default: \"Replace\""
                          enum:
                          - replace
                          - Replace
                          - keep
                          - Keep
                          - drop
                          - Drop
                          - hashmod
                          - HashMod
                          - labelmap
                          - LabelMap
                          - labeldrop
                          - LabelDrop
                          - labelkeep
                          - LabelKeep
                          - lowercase
                          - Lowercase
                          - uppercase
                          - Uppercase
                          - keepequal
                          - KeepEqual
                          - dropequal
                          - DropEqual
                          type: string
                        modulus:
                          description: "Modulus to take of the hash of the source
                            label values. \n Only applicable when the action is `HashMod`."
                          format: int64
                          type: integer
                        regex:
                          description: Regular expression against which the extracted
                            value is matched.
                          type: string
                        replacement:
                          description: "Replacement value against which a Replace
                            action is performed if the regular expression matches.
                            \n Regex capture groups are available."
                          type: string
                        separator:
                          description: Separator is the string between concatenated
                            SourceLabels.
                          type: string
                        sourceLabels:
                          description: The source labels select values from existing
                            labels. Their content is concatenated using the configured
                            Separator and matched against the configured regular expression.
                          items:
                            description: LabelName is a valid Prometheus label name
                              which may only contain ASCII letters, numbers, as well
                              as underscores.
                            pattern: ^[a-zA-Z_][a-zA-Z0-9_]*$
                            type: string
                          type: array
                        targetLabel:
                          description: "Label to which the resulting string is written
                            in a replacement. \n It is mandatory for `Replace`, `HashMod`,
                            `Lowercase`, `Uppercase`, `KeepEqual` and `DropEqual`
                            actions. \n Regex capture groups are available."
                          type: string
                      type: object
                    type: array
                  podMonitorRelabelings:
                    description: The list of relabelings for the `PodMonitor`. Applied
                      to samples before scraping.
                    items:
                      description: "RelabelConfig allows dynamic rewriting of the
                        label set for targets, alerts, scraped samples and remote
                        write samples. \n More info: https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config"
                      properties:
                        action:
                          default: replace
                          description: "Action to perform based on the regex matching.
                            \n `Uppercase` and `Lowercase` actions require Prometheus
                            >= v2.36.0. `DropEqual` and `KeepEqual` actions require
                            Prometheus >= v2.41.0. \n Default: \"Replace\""
                          enum:
                          - replace
                          - Replace
                          - keep
                          - Keep
                          - drop
                          - Drop
                          - hashmod
                          - HashMod
                          - labelmap
                          - LabelMap
                          - labeldrop
                          - LabelDrop
                          - labelkeep
                          - LabelKeep
                          - lowercase
                          - Lowercase
                          - uppercase
                          - Uppercase
                          - keepequal
                          - KeepEqual
                          - dropequal
                          - DropEqual
                          type: string
                        modulus:
                          description: "Modulus to take of the hash of the source
                            label values. \n Only applicable when the action is `HashMod`."
                          format: int64
                          type: integer
                        regex:
                          description: Regular expression against which the extracted
                            value is matched.
                          type: string
                        replacement:
                          description: "Replacement value against which a Replace
                            action is performed if the regular expression matches.
                            \n Regex capture groups are available."
                          type: string
                        separator:
                          description: Separator is the string between concatenated
                            SourceLabels.
                          type: string
                        sourceLabels:
                          description: The source labels select values from existing
                            labels. Their content is concatenated using the configured
                            Separator and matched against the configured regular expression.
                          items:
                            description: LabelName is a valid Prometheus label name
                              which may only contain ASCII letters, numbers, as well
                              as underscores.
                            pattern: ^[a-zA-Z_][a-zA-Z0-9_]*$
                            type: string
                          type: array
                        targetLabel:
                          description: "Label to which the resulting string is written
                            in a replacement. \n It is mandatory for `Replace`, `HashMod`,
                            `Lowercase`, `Uppercase`, `KeepEqual` and `DropEqual`
                            actions. \n Regex capture groups are available."
                          type: string
                      type: object
                    type: array
                type: object
              pgbouncer:
                description: The PgBouncer configuration
                properties:
                  authQuery:
                    description: 'The query that will be used to download the hash
                      of the password of a certain user. Default: "SELECT usename,
                      passwd FROM user_search($1)". In case it is specified, also
                      an AuthQuerySecret has to be specified and no automatic CNPG
                      Cluster integration will be triggered.'
                    type: string
                  authQuerySecret:
                    description: The credentials of the user that need to be used
                      for the authentication query. In case it is specified, also
                      an AuthQuery (e.g. "SELECT usename, passwd FROM pg_shadow WHERE
                      usename=$1") has to be specified and no automatic CNPG Cluster
                      integration will be triggered.
                    properties:
                      name:
                        description: Name of the referent.
                        type: string
                    required:
                    - name
                    type: object
                  parameters:
                    additionalProperties:
                      type: string
                    description: Additional parameters to be passed to PgBouncer -
                      please check the CNPG documentation for a list of options you
                      can configure
                    type: object
                  paused:
                    default: false
                    description: When set to `true`, PgBouncer will disconnect from
                      the PostgreSQL server, first waiting for all queries to complete,
                      and pause all new client connections until this value is set
                      to `false` (default). Internally, the operator calls PgBouncer's
                      `PAUSE` and `RESUME` commands.
                    type: boolean
                  pg_hba:
                    description: PostgreSQL Host Based Authentication rules (lines
                      to be appended to the pg_hba.conf file)
                    items:
                      type: string
                    type: array
                  poolMode:
                    default: session
                    description: 'The pool mode. Default: `session`.'
                    enum:
                    - session
                    - transaction
                    type: string
                type: object
              template:
                description: The template of the Pod to be created
                properties:
                  metadata:
                    description: 'Standard object''s metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata'
                    properties:
                      annotations:
                        additionalProperties:
                          type: string
                        description: 'Annotations is an unstructured key value map
                          stored with a resource that may be set by external tools
                          to store and retrieve arbitrary metadata. They are not queryable
                          and should be preserved when modifying objects. More info:
                          http://kubernetes.io/docs/user-guide/annotations'
                        type: object
                      labels:
                        additionalProperties:
                          type: string
                        description: 'Map of string keys and values that can be used
                          to organize and categorize (scope and select) objects. May
                          match selectors of replication controllers and services.
                          More info: http://kubernetes.io/docs/user-guide/labels'
                        type: object
                    type: object
                  spec:
                    description: 'Specification of the desired behavior of the pod.
                      More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
                    type: object
                    x-kubernetes-preserve-unknown-fields: true
                type: object
              type:
                default: rw
                description: 'Type of service to forward traffic to. Default: `rw`.'
                enum:
                - rw
                - ro
                type: string
            required:
            - cluster
            - pgbouncer
            type: object
          status:
            description: 'Most recently observed status of the Pooler. This data may
              not be up to date. Populated by the system. Read-only. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status'
            properties:
              instances:
                description: The number of pods trying to be scheduled
                format: int32
                type: integer
              secrets:
                description: The resource version of the config object
                properties:
                  clientCA:
                    description: The client CA secret version
                    properties:
                      name:
                        description: The name of the secret
                        type: string
                      version:
                        description: The ResourceVersion of the secret
                        type: string
                    type: object
                  pgBouncerSecrets:
                    description: The version of the secrets used by PgBouncer
                    properties:
                      authQuery:
                        description: The auth query secret version
                        properties:
                          name:
                            description: The name of the secret
                            type: string
                          version:
                            description: The ResourceVersion of the secret
                            type: string
                        type: object
                    type: object
                  serverCA:
                    description: The server CA secret version
                    properties:
                      name:
                        description: The name of the secret
                        type: string
                      version:
                        description: The ResourceVersion of the secret
                        type: string
                    type: object
                  serverTLS:
                    description: The server TLS secret version
                    properties:
                      name:
                        description: The name of the secret
                        type: string
                      version:
                        description: The ResourceVersion of the secret
                        type: string
                    type: object
                type: object
            type: object
        required:
        - metadata
        - spec
        type: object
    served: true
    storage: true
    subresources:
      scale:
        specReplicasPath: .spec.instances
        statusReplicasPath: .status.instances
      status: {}
